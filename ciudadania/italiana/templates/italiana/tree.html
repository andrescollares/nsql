<!DOCTYPE html>

{% load static %}
<head>
  <title>Family Tree</title>
  <!-- <link rel="shortcut icon" type="image/png" href="{% static 'favicon.ico' %}"/> -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="{% static 'tree.css' %}">
</head>

<body>
  <div class="title">
    <h1>
      Family Tree
    </h1>
  </div>
  <div id="graph"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js" integrity="sha512-WFN04846sdKMIP5LKNphMaWzU7YpMyCU245etK3g/2ARYbPK9Ub18eG+ljU96qKRCWh+quCY7yefSmlkQw1ANQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js" integrity="sha512-RJJ1NNC88QhN7dwpCY8rm/6OxI+YdQP48DrLGe/eSAd+n+s1PXwQkkpzzAgoJe4cZFW2GALQoxox61gSY2yQfg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-dtree@2.4.1/dist/dTree.min.js"></script>
  <script>
    tree = dTree.init({{ treeData | safe }}, {
      target: "#graph",
      debug: true,
      hideMarriageNodes: false,
      marriageNodeSize: 25,
      width: 1000,
      height: 1000,
      callbacks: {
        nodeClick: function(name, extra) {
          console.log(name);
        },
        textRenderer: function(name, extra, textClass) {
          // This callback is optinal but can be used to customize
          // how the text is rendered without having to rewrite the entire node
          // from screatch.
          if (extra && extra.nickname)
          name = name + " (" + extra.nickname + ")";
          return "<p align='center' class='" + textClass + "' style='word-wrap:break-word; '><span>" + name + "</span><span>" + extra.nacimiento + ((extra.defuncion === "") ? "" : " - ") + extra.defuncion + ((extra.defuncion === "") ? "" : "") + "</span></p>";
        },
        nodeSize: function(nodes, width, textRenderer) {
          _.map(nodes, function(n) {
            n.cHeight = 142;
            n.cWidth = width;
          });

          return [width, 106];
        },
        nodeHeightSeperation: function(nodeWidth, nodeMaxHeight) {
          return 200;
        },
        nodeRenderer: function(name, x, y, height, width, extra, id, nodeClass, textClass, textRenderer) {
          // This callback is optional but can be used to customize the
          // node element using HTML.
          let node = '';
          node += '<div ';
          node += 'style="height:100%;width:100%;max-width:100%" ';
          node += 'class="' + nodeClass + '" ';
          node += 'id="node' + id + '">\n';
          node += "<div class='img-container'><img class='perfil' src='"
          if ("image" in extra) {
            node +=  extra.image
          } else if (nodeClass === "MALE") {
            node += '{% static 'placeholder_hombre.jpg' %}'
          } else if (nodeClass === "FEMALE"){
            node += '{% static 'placeholder_mujer.jpg' %}'
          } else {
            node += '{% static 'placeholder_otro.jpg' %}'
          }
          node += "' height='85'/></div>"
          node += "<div class='txt-container'>" + textRenderer(name, extra, textClass) + "</div>";
          node += "<div class='flag-container'>";
          extra.nacionalidades.forEach(nacionalidad => node += "<img class='flag' src='{% static 'it.gif' %}'>");
          node += '</div></div>';
          return node;
        },
        marriageRenderer: function(x, y, height, width, extra, id, nodeClass) {
          let node = '';
          node += '<div '
          node += 'style="height:100%;width:100%;" ';
          node += 'class="' + nodeClass + '" ';
          node += 'id="node' + id + '">\n';
          node += "<span align='center'>ðŸ’˜<span>";
          node += '</div>';
          return node;
        },
      },
      margin: {
        top: 0,
        right: 0,
        bottom: 0,
        left: 0
      },
    });
    var tree_g = document.querySelector('g');
    width = tree_g.getBoundingClientRect().width
    height = tree_g.getBoundingClientRect().height
    container = document.querySelector('#graph');
    container.setAttribute("style", "width: " + width + "px; height: " + height + "px");
    svg = document.querySelector('svg').setAttribute("viewBox", "0 0 " + width + " " + height);
    title = document.querySelector('.title').setAttribute("style", "width: " + width + "px;");
    body = document.querySelector('body').setAttribute("style", "width: " + (width + 16) + "px;");
    // html = document.querySelector('html').setAttribute("style", "width: " + (width + 16) + "px;");
    tree.zoomToFit(duration = 0);
  </script>
</body>

</html>
<!DOCTYPE html>
