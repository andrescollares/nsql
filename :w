import json
import uuid

from django.shortcuts import render
from django.http import HttpResponse
from django.views.decorators.csrf import csrf_exempt
from datetime import datetime

from neomodel.match import Traversal, OUTGOING, db

from .models import Person, PartnerRel

# Create your views here.


@csrf_exempt
def index(request):
    if request.method == "POST":
        print(request.POST)
        print(request.FILES)
        data = request.POST.dict()

        if data.get("name") == "bolo":
            return HttpResponse("", status=201)
        else:
            return HttpResponse("", status=404)
    else:
        offspring = get_offspring("d1b44fb3-e415-458d-a8bf-edff17669cf9", "Jonathan Farley")
        text= ""
        for person in offspring:
          if text=="":  
            text = person.name
          else:
            text += ", " + person.name
        return HttpResponse(text)

def add_family_uuid(member, family_uuid):
    member["family_uuid"] = family_uuid
    member["birthday"] = datetime.strptime(member["birthday"], '%Y-%m-%d')
    if member.get("citizenship_resignation_date"):
      member["citizenship_resignation_date"] = datetime.strptime(member["citizenship_resignation_date"], '%y-%m-%d')
    return member

@csrf_exempt
def create_family(request):
    if request.method == "POST":
        data = request.POST.dict()
        members = json.loads(data["members"])
        relations_partners = json.loads(data["relations_partners"])
        relations_offsprings = json.loads(data["relations_offsprings"])
        family_uuid = uuid.uuid4()
        persons = [add_family_uuid(member, family_uuid) for member in members]
        
        with db.transaction:
            people = Person.create(*persons)

        for relation_partner in relations_partners:
            people[relation_partner["first"]].partner.connect(people[relation_partner["second"]], {"is_married": relation_partner["married"]})

        for relation_offspring in relations_offsprings:
            people[relation_offspring["first"]].offspring.connect(people[relation_offspring["second"]])
    # TODO redirect to the algorithm run
        return HttpResponse("", status=201)

def get_offspring(family_uuid, name):
  query = (
    'MATCH ((p1:Person{family_uuid:$family_uuid, name:$name}) - [:OFFSPRING*1..] -> (p2:Person{family_uuid:$family_uuid}))'
    'RETURN p2'
  )
  params = {"family_uuid": family_uuid, "name": name}
  results, meta = db.cypher_query(query, params)
  offspring = [Person.inflate(row[0]) for row in results]
  return offspring

@csrf_exempt
def process_family(request, family_uuid):
    if request.method == "GET":
        family = Person.nodes.filter(family_uuid=family_uuid)
        # Dado que la ciudadanía se hereda desde familiares italianos
        # filtraremos por los mismos y haremos recorridas transversales
        italian_relatives = family.filter(has_citizenship=True)
        for italian_relative in italian_relatives:
            pass
            # Hacer query que consiga a todos los descendientes de un italiano

        context = {"familyUUID": family_uuid, "treeData":familia_a_json(family)}
        return render(request, template_name="tree.html", context=context)

# Código de gestari para generar el json a pasarle a la libreria que genera el árbol
def familia_a_json(family):
    person_tree = {}

    # if familia in familiar.familias.all():
    person_tree["name"] = person.name
    person_tree["class"] = person.sex

    person_tree["extra"] = familiar_extra(person)

    parejas = familiar.get_parejas()

    if parejas:
        person_tree["marriages"] = [pareja_a_json(pareja, familiar, familia) for pareja in parejas]

    return person_tree


def pareja_a_json(pareja, familiar, familia):
    spouse = {}

    if pareja.primer_integrante == familiar:
        pareja_fam = pareja.segundo_integrante
    else:
        pareja_fam = pareja.primer_integrante

    icon = pareja.get_icono_estado
    if icon == "question-circle":
        icon = "question"

    if familia in pareja_fam.familias.all():
        spouse["name"] = pareja_fam.nombre + " " + pareja_fam.apellido
        spouse["class"] = pareja_fam.sexo or "OTHER"
        spouse["extra"] = familiar_extra(pareja_fam)

        if pareja.hijos.all():
            children = [familia_a_json(hijo, familia) for hijo in pareja.hijos.all() if familia in hijo.familias.all()]
            return {"spouse": spouse, "children": children, "extra": {"icon": icon}}

        return {"spouse": spouse, "extra": {"icon": icon}}

    return spouse


def familiar_extra(person):
    extra = {}

    if person.birthday:
        extra["nacimiento"] = person.birthday
    else:
        extra["nacimiento"] = "?"

    if person.date_of_death:
        extra["defuncion"] = person.date_of_death
    else:
        extra["defuncion"] = ""

    extra["nacionalidades"] = []
    if person.has_citizenship:
        extra["nacionalidades"].append("it.gif")

    return extra
